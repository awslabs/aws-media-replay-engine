# Media Replay Engine Samples #

This repository contains sample Plugins (Lambda functions), Profiles and ML Model Notebooks that can be used in the process of building automated video clipping pipelines using the [Media Replay Engine](https://github.com/awslabs/aws-media-replay-engine) (MRE) framework. Besides sample Plugins, Profiles and ML Models, a Fan Experience GUI is provided using which the highlights generated by MRE can be viewed from the fans' perspective.

There is also a sample HLS Harvester application included that can be used to stream HLS source content to an S3 bucket tied to the MRE processing pipeline.

This repository consists of the following applications, each of which can be deployed individually:

* `plugin-samples` - CDK to deploy all or specific sample Lambda functions into your account and register them as Plugins in MRE. In addition to deploying and registering Plugins, this application also registers all the Profiles defined under [mre-profile-samples](source/mre-profile-samples/) folder in MRE.
* `model-samples` - Contains the Notebooks to deploy different ML Models used by the sample Plugins. These need to be **manually** deployed and registered in MRE **before** deploying the sample Plugins.
* `fan-experience-frontend` - CDK to deploy the Fan Experience GUI into your account.
* `hls-harvester-sample` - CDK to deploy the HLS Harvester Sample application into your account.
* `live-news-segmenter` - CDK to deploy the Live News Segmenter into your account.

# Install

## Prerequisites

* AWS MRE Framework (https://github.com/awslabs/aws-media-replay-engine)

> **NOTE:** Because of the way we build docker image for some of the sample plugins, systems with an Apple M series (M1, M2, etc.) processor are currently not supported for installing the `plugin-samples` application. In such scenarios, an AWS Cloud9 environment could be used for the installation.

## Build from scratch and deploy using AWS CDK

Run the following commands to build and deploy the sample applications from scratch. Be sure to define a value for `REGION` first.

```
REGION=[specify the region where MRE is deployed in a format like us-east-1]
deployment_dir=$(pwd)/deployment
source_dir=$(pwd)/source
```

### plugin-samples

> **NOTE:** The sample Plugins are present under `source/mre-plugin-samples/Plugins` directory.

> **NOTE:** Please ensure that you have already deployed and registered all the sample ML Models present under `source/mre-model-samples/` in MRE before proceeding further. Failure to do so will impact the registration of one or more sample Plugins.

Deploy the `plugin-samples` application using the following command
```
cd $deployment_dir
./build-and-deploy.sh --app plugin-samples --region $REGION [--profile <aws-profile>]
```

By default, the `plugin-samples` application deploys and registers the plugins in the list below and creates a set of profiles leveraging these plugins. The profiles are present in `source/mre-profile-samples/`. 

```
{
    "Plugins": [
        "SegmentBySceneChange",
        "DetectTennisScoreBoxData",
        "DetectCameraScene",
        "LabelTennisScore",
        "DetectAudioPeaks",
        "SegmentByKeyMoment",
        "LabelBasic",
        "OptimizePassThrough",
        "SegmentPassThrough100",
        "LabelPassThrough",
        "DetectPassThrough100"
    ]
}
```
The above plugins list is present in `source/mre-plugin-samples/cdk/cdk.context.json`. 
> **NOTE:** Since the plugins mentioned above are part of the profiles that are deployed through the `plugins-samples` cdk application, they **should not** be deleted/removed from the list **unless** the corresponding profiles are also deleted from `source/mre-profile-samples/`. 

> **NOTE:** `Plugins` list in `source/mre-plugin-samples/cdk/cdk.context.json`cannot be **empty**. 

To deploy and register specific plugins that are provided in the `source/mre-plugin-samples/Plugins` directory, add their corresponding plugin name in the `Plugins` list and run the above deployment command.

The CDK application looks through the `source/mre-plugin-samples/Plugins` directory for the plugins in the `Plugins` list and only deploys those plugins that have a matching directory name. 
i.e. For the list above, the CDK application deploys the following plugins:
1. `source/mre-plugin-samples/Plugins/SegmentBySceneChange`
2. `source/mre-plugin-samples/Plugins/DetectTennisScoreBoxData`
3. `source/mre-plugin-samples/Plugins/DetectCameraScene`
4. `source/mre-plugin-samples/Plugins/LabelTennisScore`
5. `source/mre-plugin-samples/Plugins/DetectAudioPeaks`
6. `source/mre-plugin-samples/Plugins/SegmentByKeyMoment`,
7. `source/mre-plugin-samples/Plugins/LabelBasic`,
8. `source/mre-plugin-samples/Plugins/OptimizePassThrough`,
9. `source/mre-plugin-samples/Plugins/SegmentPassThrough100`,
10. `source/mre-plugin-samples/Plugins/LabelPassThrough`,
11. `source/mre-plugin-samples/Plugins/DetectPassThrough100`

 
> **NOTE:** If any of the already registered plugins are removed from the above list during re-deployment of the cdk stack then the plugins are deleted from MRE framework.  

#### Bring Your Own Plugin:

If you have created your own plugin that you would like to include as a part of the `plugin-samples` application deployment, do the following:

1. Create a folder for your plugin under `source/mre-plugin-samples/Plugins` directory.
2. In that folder, include the source code of your plugin Lambda function (`<plugin_name>.py`), MRE plugin registration configuration (`config.json`), and readme (`README.md`), 
3. If the plugin requires any libraries, you can create either a `Dockerfile` associated with the plugin (if the size of the dependent libraries are over the [lambda deployment package size limits](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html)) or specify the dependencies in a`requirements.txt` file.
> **Note:** `source/mre-plugin-samples/Plugins/template_plugin_config.json.template`has the template to create a new plugin configuration. `source/mre-plugin-samples/Plugins/Dockerfile.template` has the template to create the Dockerfile for installing all the dependent libraries of the plugin.


Now, to deploy this plugin, you can add the name of the plugin to the `Plugins` list in `source/mre-plugin-samples/cdk/cdk.context.json` file as shown above. Then run the above deployment command.

To add new profiles with one or more plugins:

1. Create a folder for your profile under `source/mre-profile-samples/` directory.
2. In that folder, include the MRE profile registration configuration (`config.json`).
3. Ensure that all the plugins that are part of the profile are included in the `Plugins` list in  `source/mre-plugin-samples/cdk/cdk.context.json`  file.

> **Note:** `source/mre-profile-samples/template_profile_config.json.template` has the template to create a new profile configuration.

### fan-experience-frontend

```
cd $deployment_dir
./build-and-deploy.sh --app fan-experience-frontend --region $REGION [--profile <aws-profile>]
```

### hls-harvester-sample

```
cd $source_dir/mre-video-ingestion-samples/HLS_Harvester
cp harvester_config_template.py harvester_config.py
```

Open `harvester_config.py` and fill in the corresponding value for all the variables present. Once done, run the following commands to deploy the application:

```
cd $deployment_dir
./build-and-deploy.sh --app hls-harvester-sample --region $REGION [--profile <aws-profile>]
```

### live-news-segmenter

```
cd $deployment_dir
./build-and-deploy.sh --app [live-news-segmenter || live-news-segmenter-ui || live-news-segmenter-api] --region $REGION [--profile <aws-profile>]
```

# Code Layout

| Path                                              | Description                                                                                                                 |
| :------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------- |
| deployment/                                       | shell scripts                                                                                                               |
| deployment/build-and-deploy.sh                    | shell script to build and deploy plugin-samples, fan-experience-frontend and live-news-segmenter applications using AWS CDK |
| source/                                           | source code folder                                                                                                          |
| source/custom-resource/                           | source code folder for the Lambda custom resource function to register models, plugins, and profiles in MRE                 |
| source/mre-plugin-samples/                        | source code folder for the plugin-samples application                                                                       |
| source/mre-plugin-samples/cdk/                    | plugin-samples CDK application                                                                                              |
| source/mre-plugin-samples/LambdaLayers/           | Libraries to be manually imported as Lambda Layers                                                                          |
| source/mre-plugin-samples/Plugins/                | Lambda code assets for all the sample Plugins                                                                               |
| source/mre-model-samples/                         | source code folder for the model-samples application                                                                        |
| source/mre-model-samples/Models/                  | folder containing Notebooks to deploy the sample ML Models                                                                  |
| source/mre-profile-samples/                       | folder containing sample Profile configurations                                                                             |
| source/mre-fan-experience-frontend/               | source code for the fan-experience-frontend application                                                                     |
| source/live-news-segmenter/                       | source code for the live-news-segmenter application                                                                         |
| source/mre-video-ingestion-samples/HLS_Harvester/ | source code for the hls-harvester-sample application                                                                        |

# Uninstall

## Option 1: Uninstall using AWS CDK
```
# Delete the plugin-samples application
cd MRE-Samples/source/mre-plugin-samples/cdk
cdk destroy [--profile <aws-profile>]

# Delete the fan-experience-frontend application
cd MRE-Samples/source/mre-fan-experience-frontend/cdk
cdk destroy [--profile <aws-profile>]

# Delete the hls-harvester-sample application
cd MRE-Samples/source/mre-video-ingestion-samples/HLS_Harvester/infrastructure
cdk destroy [--profile <aws-profile>]

# Delete the live-news-segmenter application
cd MRE-Samples/source/live-news-segmenter/api/infrastructure
cdk destroy [--profile <aws-profile>]
cd MRE-Samples/source/live-news-segmenter/ui/cdk
cdk destroy [--profile <aws-profile>]
```

## Option 2: Uninstall using the AWS Management Console
1. Sign in to the AWS CloudFormation console.
2. Select the MRE Plugin Samples stack.
3. Choose Delete.
4. Select the MRE Fan Experience Frontend stack.
5. Choose Delete.
6. Select the MRE HLS Harvester Sample stack.
7. Choose Delete.
8. Select the WL MRE Custom API stack.
9. Choose Delete.
10. Select the Live News Segmenter Frontend stack.
11. Choose Delete.

## Option 3: Uninstall using AWS Command Line Interface
```
aws cloudformation delete-stack --stack-name <plugin-samples-stack-name> --region <aws-region>

aws cloudformation delete-stack --stack-name <fan-experience-frontend-stack-name> --region <aws-region>

aws cloudformation delete-stack --stack-name <hls-harvester-sample-stack-name> --region <aws-region>

aws cloudformation delete-stack --stack-name <wl-mre-custom-api-stack-name> --region <aws-region>

aws cloudformation delete-stack --stack-name <live-news-segmenter-frontend-stack-name> --region <aws-region>
```

# License

This repository is licensed under [MIT-0 license](LICENSE).
